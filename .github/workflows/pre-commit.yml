name: Pre-commit Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Super fast pre-commit feedback
  quick-feedback:
    name: Quick Type & Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Fast type check
        run: |
          # Quick type check with minimal output
          npx tsc --noEmit --skipLibCheck --pretty false 2>&1 | head -20

      - name: Fast lint check
        run: |
          # Quick lint with minimal output
          npm run lint 2>&1 | head -20

      - name: Quick type safety scan
        run: |
          echo "üîç Quick type safety scan..."

          # Count critical any types
          ANY_COUNT=$(grep -r ":\s*any" src/bridge/ src/workspace/ | grep -v test | grep -v "as any" | wc -l || echo 0)
          echo "Critical any types: $ANY_COUNT"

          # Check for discriminated union
          if grep -q "type BridgeInternalCommand =" src/bridge/TUIVSCodeBridge.ts; then
            echo "‚úÖ Discriminated union found"
          else
            echo "‚ùå Discriminated union missing"
          fi

          # Quick compilation test
          if npx tsc --noEmit --skipLibCheck > /dev/null 2>&1; then
            echo "‚úÖ TypeScript compilation successful"
          else
            echo "‚ùå TypeScript compilation failed"
            echo "Run 'npm run compile' locally for details"
          fi

  # Test critical bridge functionality
  bridge-smoke-test:
    name: Bridge Smoke Test
    runs-on: ubuntu-latest
    needs: quick-feedback
    timeout-minutes: 8

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Compile
        run: npm run compile

      - name: Test bridge type construction
        run: |
          node -e "
            try {
              // Test that discriminated union types work
              const testCommands = [
                {
                  id: 'test-workspace',
                  type: 'workspace_query',
                  payload: { queryType: 'basic' },
                  timestamp: Date.now()
                },
                {
                  id: 'test-auth',
                  type: 'auth_request',
                  payload: { token: 'test-token' },
                  timestamp: Date.now()
                },
                {
                  id: 'test-file',
                  type: 'file_operation',
                  payload: { operation: 'read', path: '/test.ts' },
                  timestamp: Date.now()
                }
              ];

              console.log('‚úÖ Bridge command types constructed successfully');
              console.log('Commands tested:', testCommands.length);

              // Verify discriminated union type narrowing would work
              testCommands.forEach(cmd => {
                switch (cmd.type) {
                  case 'workspace_query':
                    if (!cmd.payload.queryType) cmd.payload.queryType = 'basic';
                    break;
                  case 'auth_request':
                    if (!cmd.payload.token) throw new Error('Token required');
                    break;
                  case 'file_operation':
                    if (!cmd.payload.operation || !cmd.payload.path) throw new Error('Operation and path required');
                    break;
                }
              });

              console.log('‚úÖ Type narrowing logic works correctly');
              process.exit(0);
            } catch (error) {
              console.error('‚ùå Bridge type test failed:', error.message);
              process.exit(1);
            }
          "

      - name: Test type safety improvements
        run: |
          node -e "
            const fs = require('fs');

            try {
              // Read and validate TUIVSCodeBridge file
              const bridgeContent = fs.readFileSync('src/bridge/TUIVSCodeBridge.ts', 'utf8');

              // Check for discriminated union
              if (!bridgeContent.includes('type BridgeInternalCommand =')) {
                throw new Error('BridgeInternalCommand discriminated union not found');
              }

              // Check for Extract usage
              const extractMatches = bridgeContent.match(/Extract<BridgeInternalCommand/g);
              if (!extractMatches || extractMatches.length < 3) {
                throw new Error('Insufficient Extract utility usage in handlers');
              }

              // Check for proper payload interfaces
              const payloadInterfaces = [
                'WorkspaceQueryPayload',
                'FileOperationPayload',
                'CommandExecutionPayload',
                'ContextRequestPayload',
                'AuthRequestPayload'
              ];

              for (const interfaceName of payloadInterfaces) {
                if (!bridgeContent.includes(\`export interface \${interfaceName}\`)) {
                  throw new Error(\`Missing exported interface: \${interfaceName}\`);
                }
              }

              console.log('‚úÖ Type safety implementation validated');
              console.log('- Discriminated union: ‚úÖ');
              console.log('- Extract utility usage: ‚úÖ (' + extractMatches.length + ' handlers)');
              console.log('- Exported payload interfaces: ‚úÖ (' + payloadInterfaces.length + ' interfaces)');

              process.exit(0);
            } catch (error) {
              console.error('‚ùå Type safety validation failed:', error.message);
              process.exit(1);
            }
          "

  # Notify about check status
  status-check:
    name: Pre-commit Status
    runs-on: ubuntu-latest
    needs: [quick-feedback, bridge-smoke-test]
    if: always()

    steps:
      - name: Report status
        run: |
          echo "# Pre-commit Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quick-feedback.result }}" = "success" ] && [ "${{ needs.bridge-smoke-test.result }}" = "success" ]; then
            echo "## ‚úÖ All checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your changes look good and are ready for full CI testing." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Some checks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the issues before the full CI pipeline runs:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.quick-feedback.result }}" != "success" ]; then
              echo "- **Type Check/Lint:** Failed" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.bridge-smoke-test.result }}" != "success" ]; then
              echo "- **Bridge Smoke Test:** Failed" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run these commands locally to debug:" >> $GITHUB_STEP_SUMMARY
            echo "- \`npm run compile\` (check TypeScript errors)" >> $GITHUB_STEP_SUMMARY
            echo "- \`npm run lint\` (check linting errors)" >> $GITHUB_STEP_SUMMARY
            echo "- \`npm test\` (run full test suite)" >> $GITHUB_STEP_SUMMARY
          fi